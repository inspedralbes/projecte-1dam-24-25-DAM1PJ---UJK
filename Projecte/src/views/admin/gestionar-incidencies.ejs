<%- include('../partials/header', { title: title }) %>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1><%= title %></h1>
        <% if (typeof incidencies !== 'undefined') { %>
            <span>Total: <%= incidencies.length %> incidència<%= incidencies.length !== 1 ? 's' : '' %></span>
        <% } %>
    </div>

    <p>Des d'aquí pots seleccionar una incidència per assignar-la a un tècnic o per editar-ne els detalls.</p>

    <% if (typeof incidencies !== 'undefined' && incidencies.length > 0) { %>
        <div class="list-group">
            <% incidencies.forEach(incidencia => { %>
                <div class="list-group-item list-group-item-action flex-column align-items-start mb-3 shadow-sm">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">
                            ID: <%= incidencia.id_incidencia %> - <%= incidencia.descripcio.substring(0, 70) %><% if (incidencia.descripcio.length > 70) { %>...<% } %>
                        </h5>
                        <small class="text-muted"><%= new Date(incidencia.datetime_creada).toLocaleDateString() %></small>
                    </div>
                    <p class="mb-1">
                        <strong>Ubicació:</strong> <%= incidencia.ubicacio %><br>
                        <strong>Estat:</strong> <span class="badge 
                            <% if (incidencia.estat === 'Oberta') { %>
                                bg-danger
                            <% } else if (incidencia.estat === 'En procès' || incidencia.estat === 'En procés') { %>
                                bg-warning text-dark
                            <% } else if (incidencia.estat === 'Tancada') { %>
                                bg-success
                            <% } else { %>
                                bg-secondary
                            <% } %>
                        "><%= incidencia.estat %></span><br>
                        <strong>Prioritat:</strong> <%= incidencia.prioritat %><br>
                        <% if (incidencia.Usuari) { %>
                            <strong>Creada per:</strong> <%= incidencia.Usuari.nom %> (ID: <%= incidencia.Usuari.id_usuari %>)<br>
                        <% } %>
                        <% if (incidencia.Tipus) { %> <%# CORREGIDO: Tipus con 'T' mayúscula %>
                            <strong>Tipus:</strong> <%= incidencia.Tipus.nom %><br>
                        <% } %>
                    </p>
                    <div class="mt-2">
                        <a href="/assignar/<%= incidencia.id_incidencia %>" class="btn btn-sm btn-primary me-2">
                            <i class="bi bi-person-plus-fill"></i> Assignar Tècnic
                        </a>
                        <a href="/incidencies/<%= incidencia.id_incidencia %>/edit" class="btn btn-sm btn-secondary">
                            <i class="bi bi-pencil-square"></i> Editar Incidència
                        </a>
                    </div>
                </div>
            <% }); %>
        </div>
    <% } else { %>
        <div class="alert alert-info" role="alert">
            No hi ha incidències registrades actualment.
        </div>
    <% } %>
</div>

<%- include('../partials/footer') %>